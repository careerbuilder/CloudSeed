{
  "Type" : "SiteDBBucket",
  "Description" : "Version 1.0.  Creates a customized S3 bucket.",
  "Parameters" : {
    "BucketShortName" : {
      "Description" : "Descriptor of Created bucket",
      "AllowedPattern" : "[a-zA-Z0-9]+",
      "Type" : "String"
    },
    "TeamName" : {
      "Description" : "Name of owning team",
      "Type" : "String"
    },
    "VPCName" : {
      "Description" : "Short name of VPC",
      "AllowedValues" : ["Test", "Prod", "Ireland"],
      "Type" : "String"
    }
  },
  "Mappings" : {
    "Info" : {
      "Test" : {
        "CIDROne" : "172.26.0.0/16",
        "CIDRTwo" : "172.21.0.0/16",
        "Name" : "useasttest"
      },
      "Prod" : {
        "CIDROne" : "172.29.0.0/16",
        "CIDRTwo" : "172.22.0.0/16",
        "Name" : "useast"
      },
      "Ireland" : {
        "CIDROne" : "172.28.0.0/16",
        "CIDRTwo" : "172.23.0.0/16",
        "Name" : "ireland"
      }
    }
  },
  "Resources" : {
    "S3Bucket" : {
      "Type" : "AWS::S3::Bucket",
      "Properties" : {
        "BucketName" : {
          "Fn::Join" : ["-", {
              "Ref" : "TeamName"
            }, {
              "Ref" : "BucketShortName"
            }, {
              "Fn::FindInMap" : ["Info", {
                  "Ref" : "VPCName"
                }, "Name"]
            }
          ]
        },
        "LifecycleConfiguration" : {
          "Rules" : [{
              "ExpirationInDays" : 120,
              "Status" : "Enabled",
              "Transition" : {
                "StorageClass" : "Glacier",
                "TransitionInDays" : 30
              }
            }
          ]
        },
        "LoggingConfiguration" : {
          "LogFilePrefix" : "Log"
        },
        "Tags" : [{
            "Key" : "TeamName",
            "Value" : {
              "Ref" : "TeamName"
            }
          }
        ]
      }
    },
    "S3Policy" : {
      "Type" : "AWS::IAM::Policy",
      "Properties" : {
        "PolicyDocument" : {
          "Id" : {
            "Fn::Join" : ["", {
                "Ref" : "TeamName"
              }, {
                "Ref" : "BucketShortName"
              }, {
                "Fn::FindInMap" : ["Info", {
                    "Ref" : "VPCName"
                  }, "Name"]
              }, "Policy"]
          },
          "Statement" : [{
              "Sid" : "IPAllow",
              "Effect" : "Allow",
              "Principal" : {
                "AWS" : "*"
              },
              "Action" : "s3:*",
              "Resource" : {
                "Ref" : "S3Bucket"
              },
              "Condition" : {
                "IpAddress" : {
                  "Fn::Or" : [{
                      "aws:SourceIp" : "204.246.246.253/32"
                    }, {
                      "aws:SourceIp" : {
                        "Fn::FindInMap" : ["Info", {
                            "Ref" : "VPCName"
                          }, "CIDROne"]
                      }
                    }, {
                      "aws:SourceIp" : {
                        "Fn::FindInMap" : ["Info", {
                            "Ref" : "VPCName"
                          }, "CIDRTwo"]
                      }
                    }
                  ]
                }
              }
            }
          ]
        },
        "PolicyName" : {
          "Fn::Join" : ["-", {
              "Ref" : "TeamName"
            }, {
              "Ref" : "BucketShortName"
            }, {
              "Fn::FindInMap" : ["Info", {
                  "Ref" : "VPCName"
                }, "Name"]
            }, "Policy"]
        }
      }
    }
  },
  "Outputs" : {
    "BucketID" : {
      "Description" : "ID of created ACL",
      "Value" : {
        "Ref" : "S3Bucket"
      }
    }
  },
  "Connections" : {}

}
